# 對比度熱力圖 - Chrome 擴展程式

一個 Chrome 擴展程式，可掃描網頁中的文字對比度問題並以視覺熱力圖的方式顯示。使用 **APCA (Advanced Perceptual Contrast Algorithm)** 規範進行更準確、基於人類視覺感知的對比度評估。支持多種語言（English / 中文）和淺色/深色模式。

## 功能特性

- **APCA 對比度分析**：使用先進的感知對比度算法 (APCA) 進行準確的感知式對比度評估
- **視口專用檢測**：只標記當前視口中可見的元素
- **滾動時實時重新掃描**：當您滾動時自動重新掃描並更新熱力圖
- **視覺熱力圖疊加層**：色彩編碼的畫布顯示 APCA 相容性級別
  - **紅色**：不符合 (Lc < 30 - 對比度不足)
  - **黃色**：AA (Lc 45-59 - 標準對比度)
  - **藍色**：AAA (Lc ≥ 60 - 增強對比度)
- **可調整的透明度**：控制透明度 (10% - 80%)
- **多語言支持**：英文和中文 (自動偵測或手動選擇)
- **主題支持**：淺色和深色模式，具有系統偏好設置偵測
- **性能優化**：原生 JavaScript 和防抖的滾動處理

## 詳細功能

### 語言支持
- **自動偵測**：首次使用時自動偵測瀏覽器語言
- **手動選擇**：隨時在彈出視窗中更改語言
- **持久化設置**：語言和主題偏好保存到 Chrome Storage

### 主題支持
- **系統偵測**：自動偵測作業系統深色模式偏好
- **手動覆蓋**：在淺色和深色主題之間切換
- **平滑過渡**：無需重新加載即可進行無縫主題切換

### 智能掃描
- **僅文本檢測**：只分析實際文本內容，跳過空元素
- **視口優化**：只掃描並突出顯示當前視口中的可見文本
- **動態更新**：滾動時自動重新掃描（使用 100ms 防抖以提高性能）
- **色彩準確性**：通過 DOM 樹遍歷遞歸查找有效的背景色

## 技術棧

- **構建工具**：Vite 5.4+
- **框架**：React 18 (彈出視窗 UI)
- **語言**：JavaScript (ES6+)
- **樣式**：Tailwind CSS + PostCSS（深色模式支持）
- **國際化**：具有 Chrome Storage 的自訂 i18n 模組
- **擴展程式**：Manifest V3 搭配 @crxjs/vite-plugin

## 快速開始

### 1. 安裝依賴項
```bash
npm install
```

### 2. 構建擴展程式
```bash
npm run build
```

### 3. 在 Chrome 中加載
- 打開 `chrome://extensions/`
- 啟用右上角的「開發者模式」
- 點擊「加載未封裝項目」
- 選擇 `dist/` 資料夾

### 4. 使用擴展程式
- 點擊工具欄中的擴展程式圖示
- 選擇您偏好的語言（English 或 中文）
- 選擇主題（淺色或深色）
- 點擊「啟用掃描器」開啟功能
- 根據需要調整透明度滑塊
- 滾動時會自動觸發重新掃描，並實時更新

## 開發

運行帶有監視模式的開發伺服器：
```bash
npm run dev
```

文件更改時自動重新構建。

## 專案結構

```
contrast-heatmap/
├── src/
│   ├── content/index.js              # 內容指令碼（全頁掃描器）
│   ├── popup/
│   │   ├── App.jsx                   # React 彈出視窗 UI (i18n & 主題)
│   │   ├── App.css                   # Tailwind 樣式
│   │   ├── main.jsx                  # React 入口
│   │   └── popup.html                # HTML 模板
│   ├── background/service-worker.js  # 服務背景工作執行緒
│   └── utils/
│       ├── color.js                  # APCA 對比度計算
│       └── i18n.js                   # 國際化 (i18n) 和主題支持
├── _locales/
│   ├── en/messages.json              # 英文翻譯
│   └── zh/messages.json              # 中文翻譯
├── public/icons/                     # 擴展程式圖示
├── manifest.json                     # Manifest V3
├── vite.config.js                    # 構建配置
├── tailwind.config.js                # Tailwind 配置（深色模式）
├── postcss.config.js                 # PostCSS 配置
├── package.json                      # 依賴項
└── README.md                         # 英文說明（此檔案）
```

## 工作原理

### 內容指令碼 (`src/content/index.js`)
1. 創建一個絕對定位的畫布疊加層，覆蓋整個文檔
2. 使用 `TreeWalker` 查找所有文本節點（跳過空白和空元素）
3. 對視口中每個可見的文本節點：
   - 獲取計算後的前景色（來自 CSS）
   - 遞歸查找有效的背景色（通過 DOM 樹遍歷）
   - 計算 APCA Lc（亮度對比）值
   - 根據 APCA 閾值映射到色彩級別（失敗/AA/AAA）
   - 使用文檔座標在畫布上繪製彩色矩形
4. **滾動處理**：
   - 監聽具有 100ms 防抖的滾動事件
   - 滾動時自動重新掃描並重繪
   - 將視口座標轉換為文檔座標以確保準確性
5. 響應彈出視窗消息（啟用/禁用/不透明度更新）

### 彈出視窗 UI (`src/popup/App.jsx`)
- React 組件，具有語言選擇器、主題選擇器、開關和透明度滑塊
- 支持英文和中文（自動偵測或手動選擇）
- 支持淺色和深色模式（自動偵測或手動選擇）
- 將偏好設置保存到 `chrome.storage.local`
- 通過 `chrome.tabs.sendMessage` 向內容指令碼發送消息
- 顯示 APCA 色彩圖例及級別描述

### 國際化 (`src/utils/i18n.js`)
- 支持英文和中文，具有自動瀏覽器偵測
- 自動偵測系統主題偏好（淺色/深色）
- 用戶可以手動切換語言和主題
- 在 Chrome Storage 中持久化兩個偏好設置
- 所有 UI 文本都可通過 `t()` 函數進行翻譯

### 色彩工具 (`src/utils/color.js`) - APCA 實現

**關鍵函數：**
- **`calculateAPCAContrast()`**：使用 sRGB 到線性 RGB 轉換實現 APCA 算法
- **`getAPCALevel()`**：將 APCA Lc 值映射到失敗/AA/AAA 級別
- **`calculateLuminance()`**：sRGB 亮度計算輔助函數（APCA 中的中間步驟）
- **`getHeatmapColor()`**：返回用於可視化的 RGBA 色彩字符串
- **`parseColor()`**：將 HEX/RGB/RGBA 色彩字符串轉換為 RGB 物件

## 色彩指南與 APCA 標準

### 熱力圖色彩

| 顏色 | APCA 級別 | Lc 範圍 | 含義 | 推薦用途 |
|------|----------|--------|------|---------|
| 🔴 紅色 | 失敗 | Lc < 30 | 對比度不足 | 不推薦 |
| 🟡 黃色 | AA | Lc 45-59 | 標準對比度 | 普通文本可接受 |
| 🔵 藍色 | AAA | Lc ≥ 60 | 增強對比度 | 優異的可讀性 |

### APCA (先進感知對比度算法)

APCA 是基於人類視覺感知開發的更準確的對比度算法，由 W3C 開發。它提供比舊的 WCAG 2.0 對比度比值更好的實際可讀性評估。

**與 WCAG 2.0 的主要差異：**

| 方面 | WCAG 2.0 | APCA |
|------|----------|------|
| **計算方式** | 簡單亮度比 (1-21:1) | 感知式 Lc 值 (-108 到 108) |
| **準確性** | 對實際用途的準確性較低 | 更符合實際感知 |
| **字體大小** | 字體大小影響通過/失敗閾值 | 在算法中隱含考慮 |
| **方向性** | 無方向差異 | 亮/暗背景內容很重要 |
| **數值** | 4.5:1 (AA)、7:1 (AAA) | 45 (AA)、60 (AAA) |

### APCA 計算詳情

APCA 算法的工作方式如下：

1. **將色彩從 sRGB 轉換為線性 RGB：**
   ```
   對每個色彩通道 (R, G, B)：
   如果 sRGB ≤ 0.03928：線性 = sRGB / 12.92
   否則：線性 = ((sRGB + 0.055) / 1.055)^2.4
   ```

2. **計算相對亮度 (Y)：**
   ```
   Y = 0.2126 × R + 0.7152 × G + 0.0722 × B
   ```

3. **應用 APCA 對比度公式：**
   ```
   Lc = sign(Yfg - Ybg) × (|Yfg - Ybg|)^0.37
   縮放至約 -108 到 108 範圍
   ```

### 色彩轉換範例

**範例 1：黑色文本在白色背景上**
- 文本：RGB(0, 0, 0) → 亮度 ≈ 0
- 背景：RGB(255, 255, 255) → 亮度 ≈ 1.0
- APCA Lc ≈ 108（完美 - AAA）
- WCAG 2.0：21:1 (AAA)

**範例 2：灰色文本在白色背景上**
- 文本：RGB(128, 128, 128) → 亮度 ≈ 0.216
- 背景：RGB(255, 255, 255) → 亮度 ≈ 1.0
- APCA Lc ≈ 57（AA）
- WCAG 2.0：4.6:1 (AA)

### 為什麼選擇 APCA？

1. **感知準確性**：更好地反映人類實際感知對比度的方式
2. **實際可讀性**：更適用於各種文本大小和環境
3. **未來標準**：可訪問性標準的推薦方向
4. **更好的指導**：提供更細緻的對比度評估

## 可用命令

```bash
npm run dev      # 帶監視模式的開發伺服器
npm run build    # 生產構建（生成 dist/）
npm run preview  # 本地預覽構建的擴展程式
```

## 檔案說明

- **`src/content/index.js`** - 掃描頁面並繪製熱力圖疊加層的內容指令碼。處理滾動事件、動態重新掃描和管理畫布疊加層。
- **`src/popup/App.jsx`** - 帶有語言選擇器、主題選擇器、啟用/禁用開關和不透明度控制的彈出視窗 UI 的 React 組件（支持深色模式）
- **`src/utils/color.js`** - APCA（先進感知對比度算法）實現，包括色彩解析、亮度計算和對比度級別映射
- **`src/utils/i18n.js`** - 國際化和主題模組，用於語言偵測、存儲、主題偵測和翻譯實用程式
- **`manifest.json`** - 擴展程式配置 (Manifest V3)，帶有 i18n 訊息佔位符
- **`_locales/en/messages.json`** - 擴展程式名稱和描述的英文翻譯
- **`_locales/zh/messages.json`** - 擴展程式名稱和描述的中文翻譯
- **`vite.config.js`** - Vite 打包程式配置，使用 @crxjs/vite-plugin 進行擴展程式構建
- **`tailwind.config.js`** - Tailwind CSS 自訂（帶深色模式選擇器支持）
- **`postcss.config.js`** - PostCSS 和 Autoprefixer 配置

## 故障排除

### 擴展程式無法加載
- 驗證在 `npm run build` 後存在 `dist/` 資料夾
- 檢查 manifest.json 是否有效（查看控制台以了解錯誤）
- 嘗試在 `chrome://extensions/` 中重新加載擴展程式

### 熱力圖不顯示
- 點擊啟用/禁用「啟用掃描器」
- 檢查頁面是否有文本內容
- 打開開發者工具控制台查看錯誤

### 色彩似乎不對
- 在 Chrome 設置中清除擴展程式數據
- 重新構建：`npm run build`
- 在 `chrome://extensions/` 中重新加載擴展程式

### 性能問題
- 大型頁面（1000+ 文本節點）可能較慢
- 這是預期的行為 - 考慮降低不透明度或在複雜網站上禁用

## 已知限制

- 無法掃描 iframe 中的文本（Chrome 安全限制）
- 隱藏元素 (display: none) 被跳過
- 畫布疊加層可能會阻止文本選擇（由於絕對定位）
- 語言和主題選擇是按用戶的，不是按頁面的
- APCA 計算不考慮色覺障礙模式

## 前版本的改進

- **✨ APCA 算法**：從 WCAG 2.0 切換到 APCA，進行更準確、感知式的對比度評估
- **✨ 深色模式支持**：添加了淺色/深色主題切換，帶有系統偏好偵測
- **✨ 實時重新掃描**：滾動時重新掃描並更新熱力圖
- **✨ 視口專用標記**：只突出顯示當前視口中的可見文本
- **✨ 多語言支持**：英文和中文，帶自動偵測
- **✨ 座標準確性**：正確的文檔到視口座標轉換
- **✨ 改進的 UI/UX**：改進的彈出視窗佈局，具有統一的設置控制

## 瀏覽器支持

- Chrome 88+
- Edge 88+（基於 Chromium）

## 版本

v1.0.0 - 基於 APCA 的對比度掃描，具有多語言和主題支持

## 更新日誌

### v1.0.0
- ✨ **APCA 算法**：用 APCA 替換 WCAG 2.0，進行感知式對比度評估
- ✨ **深色模式支持**：添加了淺色/深色主題切換，帶系統偏好偵測
- ✨ 滾動時實時更新熱力圖
- ✨ 僅視口元素檢測
- ✨ 多語言支持（English / 中文）
- ✨ 改進的座標準確性
- ✨ 修復了畫布清除和殘留高亮問題
- ✨ 防抖滾動事件以提高性能

## 參考資源

### APCA 文檔
- [WCAG 3 APCA 對比度](https://www.w3.org/WAI/WCAG3/0/#contrast) - 官方 W3C APCA 規範
- [可訪問色彩博客](https://www.accessible-colors.com/) - APCA 工具和說明
- [APCA GitHub](https://github.com/Myndex/APCA) - 開源 APCA 實現

### 對比度標準
- [WCAG 2.1 對比度](https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html) - WCAG 2.0/2.1 對比度要求
- [WebAIM 對比度檢查器](https://webaim.org/resources/contrastchecker/) - 流行的對比度檢查工具
- [可訪問色彩](https://accessible-colors.com/apca-contrast-calculator) - APCA 計算器工具

## 授權

MIT
